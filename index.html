<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NNN & Self-Discipline Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* New Futuristic Font */
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #000000; /* Deep Black base */
            color: #FF4500; /* Orange-Red base text */
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            
            /* --- CUSTOM BACKGROUND IMAGE STYLES --- */
            background-image: url('Hyakkimaru-Artwork-Resolution-HD-Anime-4K-Images-P-iphone.jpg');
            background-size: cover; /* Cover the entire viewport */
            background-position: center top; /* Center the image */
            background-attachment: fixed; /* Fixes the image during scroll */
        }

        /* Dark Overlay for Readability (Crucial for image backgrounds) */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* 85% Black overlay */
            z-index: -2;
            pointer-events: none;
        }

        /* Neon Grid Effect (Subtle overlay for atmosphere) */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(to right, rgba(255, 0, 0, 0.1) 1px, transparent 1px), /* Neon Red lines */
                linear-gradient(to bottom, rgba(50, 0, 0, 0.1) 1px, transparent 1px); /* Dark Red lines */
            background-size: 30px 30px;
            opacity: 0.5; /* Slightly more visible grid */
            z-index: -1;
            pointer-events: none;
        }

        /* Neon Glow Effect for Containers (Data Chips) */
        .neon-container {
            background-color: rgba(10, 10, 10, 0.95); /* Very Dark, slightly transparent background */
            border: 1px solid #8B0000; /* Dark Red border */
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6), 0 0 30px rgba(139, 0, 0, 0.4); /* Red + Darker Red glow */
            transition: all 0.3s ease-in-out;
            backdrop-filter: blur(2px); /* Slight blur for futuristic glass effect */
        }

        /* Neon Glow Hover for Containers */
        .neon-container:hover {
            box-shadow: 0 0 20px rgba(255, 50, 50, 0.8), 0 0 40px rgba(255, 0, 0, 0.6);
        }

        /* Neon Glow for Main Titles - Glow effect removed for h1, but keeping the class for potential use */
        .neon-title {
            color: #FF0000; /* Electric Red */
            /* Removed text-shadow */
            font-weight: 700;
        }

        /* Day Card Styles */
        .day-card {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: #1A0000; /* Very dark red */
        }
        .day-card:hover:not(.completed) {
            transform: scale(1.05);
            border-color: #FF4500; /* Orange-Red border on hover */
            box-shadow: 0 0 5px #FF4500;
        }
        .completed {
            background-color: #102000 !important; /* Dark olive green base */
            border-color: #A3FF00; /* Neon Green (Success) */
            box-shadow: 0 0 5px #A3FF00, inset 0 0 5px #A3FF00;
        }
        .completed .day-title {
            text-decoration: line-through;
            opacity: 0.8;
            color: #DFFF80; /* Pale Green */
            text-shadow: 0 0 5px #A3FF00;
        }
        .day-title {
            color: #FF4500;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(255, 69, 0, 0.5);
        }
        .day-card p {
            font-weight: 700;
        }

        /* Custom Challenge Items */
        .custom-challenge-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background-color: #1A0A0A; /* Darker red-black */
            border-left: 3px solid #FF0000;
            transition: background-color 0.3s;
        }
        .custom-challenge-item.completed {
            background-color: #0F1E00; /* Neon Green success background */
            border-left: 3px solid #A3FF00;
        }

        /* Notification Dot Animation */
        .dot-ping {
            animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        @keyframes ping {
            75%, 100% {
                transform: scale(2);
                opacity: 0;
            }
        }
        
        /* Pulse for Alert Bell */
        .shadow-pulse-red-alert {
            box-shadow: 0 0 5px rgba(255, 50, 50, 0.8), 0 0 10px rgba(255, 0, 0, 0.4);
            animation: pulse-red-alert 1.5s infinite;
        }
        @keyframes pulse-red-alert {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 50, 50, 0.8), 0 0 10px rgba(255, 0, 0, 0.4); }
            50% { box-shadow: 0 0 10px rgba(255, 0, 0, 1), 0 0 20px rgba(255, 50, 50, 0.8); }
        }
    </style>
</head>
<body>

    <!-- Firebase SDK Imports --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase references
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = null;

        const FIREBASE_COLLECTION_PATH = 'nnn_tracker';
        const DAYS_IN_CHALLENGE = 30;

        // Constants for Lapse Check (Assuming a November 1st start for 30 days)
        const START_DATE_MONTH = 10; // 0-indexed: 10 is November
        const START_DATE_DAY = 1;


        // Global State
        window.state = {
            completedDays: new Set(),
            customChallenges: [],
            lastSticker: null,
            isAuthReady: false,
            isLoading: false,
            // Custom challenges need a unique ID, we'll track the next available ID
            nextChallengeId: 1,
            lastCompletedDayId: null,
        };

        const initFirebase = async () => {
            try {
                // Mandatory Global Variables Check
                window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    return;
                }

                // Initialize services
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore logging

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Sign in logic
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Authentication State Listener
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        window.state.isAuthReady = true;
                        console.log("User authenticated. UID:", window.userId);
                        // Start listening to data once authenticated
                        listenToProgress();
                    } else {
                        console.log("No user signed in.");
                        window.state.isAuthReady = true;
                        // If auth fails or user signs out, we still set isAuthReady to true
                        renderApp();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('loading-state').innerHTML = `<p class="text-red-400">Error loading application. Check console for details.</p>`;
            }
        };

        // --- FIREBASE UTILITY FUNCTIONS ---

        const getProgressDocRef = () => {
            if (!window.db || !window.userId) {
                console.error("Database or User ID is not ready.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/{collectionName}/progress
            return doc(window.db, "artifacts", window.appId, "users", window.userId, FIREBASE_COLLECTION_PATH, "progress");
        };

        const listenToProgress = () => {
            const docRef = getProgressDocRef();
            if (!docRef) return;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Progress data received:", data);

                    // Update state with progress data
                    window.state.completedDays = new Set(Object.keys(data.completedDays || {}).filter(key => data.completedDays[key]));
                    window.state.customChallenges = data.customChallenges || [];
                    window.state.lastSticker = data.lastSticker || null;
                    window.state.lastCompletedDayId = data.lastCompletedDayId || null; // New field
                    
                    // Ensure nextChallengeId is higher than any existing ID for uniqueness
                    const maxId = window.state.customChallenges.reduce((max, c) => Math.max(max, c.id), 0);
                    window.state.nextChallengeId = maxId + 1;

                } else {
                    // Document does not exist, initialize it
                    console.log("No progress document found. Initializing...");
                    setDoc(docRef, {
                        completedDays: {},
                        customChallenges: [],
                        lastSticker: null,
                        lastCompletedDayId: null,
                    }).catch(e => console.error("Error initializing document:", e));
                }
                renderApp(); // Re-render the UI
            }, (error) => {
                console.error("Error listening to progress:", error);
            });
        };

        // --- CORE APPLICATION LOGIC ---

        const getNotificationStatus = () => {
            // Find the highest completed day number
            const completedDayNumbers = [...window.state.completedDays]
                .map(id => parseInt(id.replace('day_', '')))
                .filter(n => !isNaN(n));
            
            const maxCompletedDay = completedDayNumbers.length > 0 ? Math.max(...completedDayNumbers) : 0;

            const now = new Date();
            // Create the challenge start date for the current year (Nov 1st)
            const challengeStart = new Date(now.getFullYear(), START_DATE_MONTH, START_DATE_DAY);

            // If the start date is in the future, the challenge hasn't started
            if (now.getTime() < challengeStart.getTime()) {
                 return { shouldNotify: false, message: "The challenge starts on November 1st! Get ready!" };
            }
            
            // Calculate days elapsed since start (1-indexed)
            const timeDifference = now.getTime() - challengeStart.getTime();
            const daysElapsed = Math.floor(timeDifference / (1000 * 3600 * 24)) + 1;

            // Expected day is capped at 30
            const expectedDay = Math.min(daysElapsed, DAYS_IN_CHALLENGE);
            
            // Check for lapse (if user is 2 or more days behind expected progress)
            const daysBehind = expectedDay - maxCompletedDay;

            let shouldNotify = false;
            let title = "Status Update";
            let message = "";

            if (maxCompletedDay === DAYS_IN_CHALLENGE) {
                title = "üéâ CHALLENGE COMPLETE: PROTOCOL SUCCESSFUL!";
                message = "You did it! 30 days complete. Congratulations on winning the challenge and building great discipline!";
            } else if (daysBehind >= 2) {
                shouldNotify = true;
                title = "üö® LAPSING WARNING: CRITICAL FAILURE IMMINENT!";
                message = `You are currently **${daysBehind} days behind** your expected progress (Day ${expectedDay}). You last completed Day ${maxCompletedDay}. The biggest risk is losing momentum‚Äîdon't let two days become three! **Complete Day ${maxCompletedDay + 1} NOW to start closing the gap!**`;
            } else if (daysBehind === 1) {
                shouldNotify = true;
                title = "‚ö†Ô∏è VIGILANCE ALERT: 1-DAY GAP DETECTED!";
                message = `You are **1 day behind** your expected progress. Complete Day ${expectedDay} now! Staying current is key to winning. Let's go!`;
            } else if (daysBehind <= 0) {
                // User is current or ahead
                title = "‚úÖ STATUS: OPTIMAL!";
                message = `You are **current** with your progress! Keep that momentum going. Discipline is a muscle, keep flexing it!`;
            }

            return { shouldNotify, title, message };
        };

        window.showNotification = () => {
            const { title, message } = getNotificationStatus();
            
            const notificationTitle = document.getElementById('notification-title');
            const notificationContent = document.getElementById('notification-content');
            
            notificationTitle.textContent = title;
            // Simple markdown parsing for bold
            // Changed color to use a contrasting theme color (Yellow/Lime)
            notificationContent.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<span class="text-yellow-400 font-bold">$1</span>'); 

            window.openModal('notification-modal');
        };

        const STICKER_PROMPTS = [
            "A determined Cyber-Samurai standing in a neon-lit, rainy alley, focusing on the sword.", // Day 1, 31
            "A high-tech ninja leaping across rooftops with electric red trails, symbolizing agility.", // Day 2, 29
            "A mechanical dragon (Ryu) with glowing red scales roaring over a futuristic cityscape.", // Day 3, 28
            "A lone figure in a heavy trench coat with a bright red cybernetic arm, holding a digital map.", // Day 4, 27
            "A fragmented digital mask with red eyes, partially corrupted but still functional.", // Day 5, 26
            "A glowing energy orb caged by black wires, representing focused power.", // Day 6, 25
            "A skeletal hand reaching for a pulsating crimson heart, surrounded by data streams.", // Day 7, 24
            "A pair of high-contrast red-and-black cyberpunk goggles reflecting a digital sky.", // Day 8, 23
            "A stylized symbol of fire and shadow, merging a flame with a razor-sharp shuriken.", // Day 9, 22
            "A sleek, black motorbike accelerating through a dark tunnel, illuminated by red exhaust.", // Day 10, 21
            "A chrome face with red geometric scars, showing battle damage and resolve.", // Day 11, 20
            "A massive, crimson-tinged orbital satellite transmitting a cryptic red signal.", // Day 12, 19
            "A digital lock snapping shut, with a key icon glowing bright red.", // Day 13, 18
            "A black tiger head with glowing red cybernetics, symbolizing ferocity.", // Day 14, 17
            "A broken neon sign reading 'WILL' flashing in aggressive red.", // Day 15, 16
        ];
        // The list is symmetric, so day 16 uses index 14, day 17 uses index 13, etc.
        const getStickerPrompt = (dayNumber) => {
            const index = dayNumber <= 15 ? dayNumber - 1 : DAYS_IN_CHALLENGE - dayNumber;
            const basePrompt = STICKER_PROMPTS[index] || "A dark, crimson cyberpunk sticker with a determined anime aesthetic.";
            return `Highly detailed, vibrant, high-contrast digital sticker in a dark, crimson cyberpunk anime style. Theme: 'Day ${dayNumber} Achievement: ${basePrompt}'. Focus on dynamic lines, electric red and deep black colors, and a strong sense of danger and will. No text, purely visual sticker art.`;
        };

        window.generateSticker = async (dayNumber) => {
            const prompt = getStickerPrompt(dayNumber);
            const apiKey = "" // Leave as-is
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            const payload = {
                instances: {
                    prompt: prompt,
                    imageSize: "512x512",
                },
                parameters: { "sampleCount": 1 }
            };

            const maxRetries = 5;
            let currentDelay = 1000; // 1 second

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         // Check for throttling (429) or other recoverable errors
                        if (response.status === 429 && i < maxRetries - 1) {
                            console.warn(`API call failed (Status: ${response.status}). Retrying in ${currentDelay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, currentDelay));
                            currentDelay *= 2; // Exponential backoff
                            continue; // Go to the next retry loop iteration
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        return imageUrl;
                    } else {
                        throw new Error("API response missing image data.");
                    }
                } catch (error) {
                    console.error("Image generation attempt failed:", error);
                    // If it's the last attempt or a non-retryable error, stop.
                    if (i === maxRetries - 1 || error.message.includes("API call failed with status")) {
                         // Fallback placeholder image URL
                        return `https://placehold.co/512x512/000000/FF0000?text=CYBER+REWARD+${dayNumber}`;
                    }
                }
            }
             // Should not be reached if maxRetries > 0, but as a final safety return
            return `https://placehold.co/512x512/000000/FF0000?text=CYBER+REWARD+${dayNumber}`;
        };

        // Function to handle day completion
        window.toggleDayComplete = async (dayNumber) => {
            const dayId = `day_${dayNumber}`;
            const isCompleted = window.state.completedDays.has(dayId);
            const docRef = getProgressDocRef();
            if (!docRef || window.state.isLoading) return;

            // 1. --- INSTANT LOCAL UI UPDATE (NEW) ---
            // Set loading state for the sticker process
            window.state.isLoading = true; 
            
            // Optimistically update the completed day set
            if (!isCompleted) {
                window.state.completedDays.add(dayId);
                window.state.lastCompletedDayId = dayId; // Update last completed ID locally
            } else {
                window.state.completedDays.delete(dayId);
            }
            renderApp(); // Rerender UI immediately with the new status
            // ------------------------------------------

            try {
                let updateData = {};
                let stickerUrl = window.state.lastSticker;

                if (!isCompleted) {
                    // Completing the day: Add to set and generate sticker
                    const completedDaysUpdate = {};
                    // Convert Set to object for Firestore write
                    updateData.completedDays = [...window.state.completedDays].reduce((acc, day) => {
                        acc[day] = true;
                        return acc;
                    }, {});
                    updateData.lastCompletedDayId = dayId;
                    
                    // Display status update while waiting for AI
                    const statusText = document.getElementById('sticker-status');
                    statusText.textContent = "TRANSMITTING REWARD DATA... PLEASE WAIT FOR AI GENERATION.";

                    // 2. Generate the reward sticker
                    stickerUrl = await window.generateSticker(dayNumber);
                    updateData.lastSticker = stickerUrl;

                    statusText.textContent = `Day ${dayNumber} Complete! Reward Unlocked!`;
                } else {
                    // Un-completing the day
                    const currentDays = [...window.state.completedDays].filter(d => d !== dayId);
                    updateData.completedDays = currentDays.reduce((acc, day) => { acc[day] = true; return acc; }, {});
                    
                    // If the day being un-completed was the last one, adjust sticker/last ID
                    if (window.state.lastCompletedDayId === dayId) {
                        updateData.lastSticker = null;
                        const maxDayNum = currentDays.length > 0 ? Math.max(...currentDays.map(id => parseInt(id.replace('day_', '')))) : null;
                        updateData.lastCompletedDayId = maxDayNum ? `day_${maxDayNum}` : null;
                    }
                }

                // 3. Update Firestore
                await updateDoc(docRef, updateData);

            } catch (e) {
                console.error("Error updating day progress or generating sticker:", e);
                const statusText = document.getElementById('sticker-status');
                statusText.textContent = "ERROR: SYSTEM FAILURE. Check console. State may be out of sync.";
                // Revert local state if error occurs (optional but robust)
                if (!isCompleted) {
                    window.state.completedDays.delete(dayId);
                } else {
                    window.state.completedDays.add(dayId);
                }
            } finally {
                // Clear loading state
                window.state.isLoading = false;
                // A final render to ensure all database-pushed data is reflected
                renderApp(); 
            }
        };

        // Function to handle custom challenge completion
        window.toggleCustomChallenge = async (challengeId) => {
            const docRef = getProgressDocRef();
            if (!docRef) return;

            // Local update first for instant feedback
            let originalChallenges = window.state.customChallenges;
            const newChallenges = originalChallenges.map(c => {
                if (c.id === challengeId) {
                    return { ...c, isComplete: !c.isComplete };
                }
                return c;
            });
            window.state.customChallenges = newChallenges;
            renderApp();

            try {
                await updateDoc(docRef, { customChallenges: newChallenges });
            } catch (e) {
                console.error("Error updating custom challenge:", e);
                // Revert local state on error
                window.state.customChallenges = originalChallenges;
                renderApp();
            }
        };

        // Function to add a custom challenge
        window.addCustomChallenge = async () => {
            const nameInput = document.getElementById('challenge-name');
            const targetInput = document.getElementById('challenge-target-day');

            const name = nameInput.value.trim();
            const targetDay = parseInt(targetInput.value);

            if (!name || isNaN(targetDay) || targetDay < 1 || targetDay > DAYS_IN_CHALLENGE) {
                document.getElementById('challenge-error').textContent = 'System Alert: Input error. Enter a valid name and a day between 1 and 30.';
                return;
            }

            const docRef = getProgressDocRef();
            if (!docRef) return;

            const newChallenge = {
                id: window.state.nextChallengeId,
                name: name,
                targetDay: targetDay,
                isComplete: false
            };

            // Local update before database call for instant feedback
            window.state.customChallenges.push(newChallenge);
            window.state.nextChallengeId++;
            renderApp();

            try {
                // Fetch the current array from Firestore and push the new object
                // NOTE: Using arrayUnion is safer for concurrency, but requires the entire object to be new.
                // We'll trust the full array replacement since we only have one user here.
                await updateDoc(docRef, {
                    customChallenges: window.state.customChallenges
                });
                // Clear inputs and close modal
                nameInput.value = '';
                targetInput.value = '';
                document.getElementById('challenge-error').textContent = '';
                window.closeModal('challenge-modal');

            } catch (e) {
                console.error("Error adding custom challenge:", e);
                // Revert local state on error (this is complex, just log the error for now)
                document.getElementById('challenge-error').textContent = 'System Error: Failed to save challenge data. Reloading.';
            }
        };

        // --- UI RENDERING FUNCTIONS ---

        const renderDays = () => {
            const container = document.getElementById('nnn-days-container');
            container.innerHTML = '';
            const fragment = document.createDocumentFragment();

            // Iterate from Day 30 down to Day 1 (Reverse Order)
            for (let i = DAYS_IN_CHALLENGE; i >= 1; i--) {
                const dayId = `day_${i}`;
                const isCompleted = window.state.completedDays.has(dayId);

                const card = document.createElement('div');
                // Updated Tailwind class for theme
                card.className = `day-card p-4 rounded-xl shadow-lg flex flex-col justify-center items-center ${isCompleted ? 'completed' : 'hover:border-red-400'} ${window.state.isLoading && !isCompleted ? 'cursor-wait opacity-70' : ''}`;
                // Disable click when loading
                card.setAttribute('onclick', window.state.isLoading ? '' : `window.toggleDayComplete(${i})`); 

                const title = document.createElement('h2');
                title.className = `day-title text-2xl transition-all`;
                title.textContent = `DAY ${i}`;

                const status = document.createElement('p');
                // Updated Tailwind class for theme
                status.className = `text-sm mt-1 ${isCompleted ? 'text-lime-300' : 'text-red-400'}`;
                
                let statusText = isCompleted ? 'PROTOCOL SECURE' : 'INITIATE PROTOCOL';
                if (window.state.isLoading && window.state.lastCompletedDayId === dayId) {
                    statusText = 'GENERATING REWARD...'; // Added specific loading text
                }
                status.textContent = statusText;

                card.appendChild(title);
                card.appendChild(status);
                fragment.appendChild(card);
            }
            container.appendChild(fragment);
        };

        const renderChallenges = () => {
            const container = document.getElementById('custom-challenges-container');
            container.innerHTML = '';

            if (window.state.customChallenges.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">No custom protocols active. Deploy a new challenge!</p>`;
                return;
            }

            window.state.customChallenges
                .sort((a, b) => a.targetDay - b.targetDay) // Sort by target day
                .forEach(c => {
                    const challengeDiv = document.createElement('div');
                    challengeDiv.className = `custom-challenge-item ${c.isComplete ? 'completed' : ''}`;

                    const nameSpan = document.createElement('span');
                    // Updated color to a contrasting shade (gray/silver)
                    nameSpan.className = 'challenge-name text-lg flex-grow text-gray-300'; 
                    nameSpan.textContent = `${c.name} (Target Day ${c.targetDay})`;

                    const button = document.createElement('button');
                    // Updated Tailwind classes for theme (Red/Green contrast)
                    button.className = `ml-4 px-3 py-1 text-xs font-semibold rounded-full transition-colors ${c.isComplete ? 'bg-red-700 hover:bg-red-600 text-white shadow-md shadow-red-700/50' : 'bg-lime-500 hover:bg-lime-400 text-black shadow-lg shadow-lime-500/50'}`;
                    button.textContent = c.isComplete ? 'RESET' : 'COMPLETE';
                    button.setAttribute('onclick', `window.toggleCustomChallenge(${c.id})`);

                    challengeDiv.appendChild(nameSpan);
                    challengeDiv.appendChild(button);
                    container.appendChild(challengeDiv);
                });
        };

        const renderSticker = () => {
            const stickerContainer = document.getElementById('sticker-container');
            stickerContainer.innerHTML = '';

            const statusText = document.getElementById('sticker-status');
            
            let statusMessage = "Complete a Day to UNLOCK your Cyber Reward!";
            if (window.state.isLoading && window.state.lastCompletedDayId) {
                 statusMessage = "TRANSMITTING REWARD DATA... PLEASE WAIT FOR AI GENERATION.";
            } else if (window.state.lastSticker) {
                 statusMessage = "LATEST REWARD ACQUIRED!";
            }
            statusText.textContent = statusMessage;


            if (window.state.lastSticker) {
                
                // 1. Image Element
                const img = document.createElement('img');
                img.src = window.state.lastSticker;
                img.alt = "AI Generated Cyber Reward Sticker";
                // Updated border color to match the Crimson theme
                img.className = "w-full max-w-xs h-auto rounded-xl shadow-2xl transition-opacity duration-500 border-4 border-red-500";
                stickerContainer.appendChild(img);

                // 2. Download Button (Anchor Tag)
                const downloadLink = document.createElement('a');
                // Set base64 data as href and 'download' attribute for automatic download
                downloadLink.href = window.state.lastSticker; 
                
                // Construct file name using the last completed day
                const day = window.state.lastCompletedDayId ? window.state.lastCompletedDayId.replace('day_', '') : 'latest';
                downloadLink.download = `Cyber_Reward_Day_${day}.png`; 

                // Updated Tailwind classes for theme (Red button)
                downloadLink.textContent = 'DOWNLOAD REWARD DATA (PNG)';
                downloadLink.className = 'mt-6 px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition-colors shadow-lg shadow-red-600/50 block w-full max-w-xs text-center';

                stickerContainer.appendChild(downloadLink);

            }
        };


        const renderApp = () => {
            document.getElementById('loading-state').style.display = window.state.isAuthReady && window.db ? 'none' : 'flex';
            document.getElementById('app-container').style.display = window.state.isAuthReady && window.db ? 'block' : 'none';

            if (window.state.isAuthReady && window.db) {
                renderDays();
                renderChallenges();
                renderSticker();
                document.getElementById('user-id-display').textContent = window.userId || 'N/A';

                // Notification check and render
                const { shouldNotify } = getNotificationStatus();
                document.getElementById('notification-dot').classList.toggle('hidden', !shouldNotify);
                
                // Change bell color if notification is active
                const bellIcon = document.getElementById('notification-bell-icon');
                bellIcon.classList.toggle('text-red-500', shouldNotify);
                // Changed to a neutral color when not notifying
                bellIcon.classList.toggle('text-gray-400', !shouldNotify); 

                // Add pulsate effect when notifying
                document.getElementById('notification-bell').classList.toggle('shadow-pulse-red-alert', shouldNotify);
            }
        };

        // --- MODAL UTILITIES ---
        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
        };

        // Initialize on load
        window.onload = initFirebase;
    </script>

    <!-- Loading State --><div id="loading-state" class="absolute inset-0 flex items-center justify-center bg-gray-900 z-50">
        <div class="text-center">
            <!-- Updated loading spinner color -->
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mx-auto mb-4"></div>
            <!-- Updated loading text color -->
            <p class="text-lg text-red-400">LOADING DISCIPLINE MATRIX...</p>
        </div>
    </div>

    <!-- Main Application Container --><div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8 hidden">
        <header class="text-center mb-8 relative">
            <!-- Removed 'neon-title' class for glow effect removal -->
            <h1 class="text-4xl md:text-5xl font-extrabold text-red-500 mb-2">30-DAY DISCIPLINE QUEST</h1>
            <!-- Changed text color to Orange-Red -->
            <p class="text-orange-400 text-lg">USER ID: <span id="user-id-display" class="font-mono text-sm bg-gray-900 p-1 rounded border border-red-800"></span></p>

            <!-- Notification Bell --><button id="notification-bell" onclick="window.showNotification()" class="absolute top-0 right-0 p-3 rounded-full transition duration-150 transform hover:scale-110" aria-label="Notifications">
                <!-- Changed default text color to gray-400 for theme (only turns red when active) -->
                <svg id="notification-bell-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <!-- Notification Dot -->
                <span id="notification-dot" class="absolute top-3 right-3 block h-3 w-3 rounded-full bg-red-500 ring-2 ring-gray-900 dot-ping hidden"></span>
            </button>
        </header>

        <!-- Main Content Layout - NEW STRUCTURE --><div class="flex flex-col gap-8">

            <!-- 1. Custom Challenges (TOP ROW - Full Width on Desktop) --><div class="neon-container p-6 rounded-2xl shadow-2xl">
                <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                    <!-- Changed text color to a dark blue for contrast, or lime for importance -->
                    <h2 class="text-2xl font-bold text-lime-400">PERSONAL MISSIONS (OPTIONAL PROTOCOLS)</h2>
                    <!-- Changed button style to Red theme -->
                    <button onclick="window.openModal('challenge-modal')" class="bg-red-600 hover:bg-red-500 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-lg shadow-red-600/50 transition-colors">
                        + DEPLOY NEW
                    </button>
                </div>
                <div id="custom-challenges-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Custom challenges will be rendered here by JS --></div>
            </div>

            <!-- 2. Main Tracker & Reward (BOTTOM ROW - Split) --><div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Column (2/3 width): Days Tracker --><div class="lg:col-span-2 neon-container p-6 rounded-2xl shadow-2xl">
                    <!-- Changed text color to Orange-Red for theme -->
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2 text-red-400">MAIN PROTOCOL TRACKER (DAY 30 ‚Üí DAY 1)</h2>
                    <p class="text-sm text-gray-400 mb-4">Click a day to log success and download your **Cyber Reward**. Viewing in reverse order. <span class="text-lime-400 font-bold">Progress is now instant!</span></p>

                    <div id="nnn-days-container" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-3">
                        <!-- Days will be rendered here by JS --></div>
                </div>

                <!-- Right Column (1/3 width): Sticker Reward --><div class="lg:col-span-1 neon-container p-6 rounded-2xl shadow-2xl text-center">
                    <!-- Changed text color to Electric Red -->
                    <h2 class="text-xl font-bold mb-4 text-red-500 border-b border-gray-700 pb-2">CRIMSON REWARD SYSTEM</h2>
                    <p id="sticker-status" class="text-sm text-gray-400 mb-4 h-5">Complete a Day to UNLOCK your Cyber Reward!</p>
                    <div id="sticker-container" class="flex flex-col items-center justify-center pt-2">
                        <!-- Sticker image and download link will be rendered here by JS --></div>
                </div>

            </div>
            <!-- End Bottom Row Split --></div>
        <!-- End Main Content Layout --></div>

    <!-- Modal for Adding Custom Challenge --><div id="challenge-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-gray-900 p-8 rounded-xl w-full max-w-md shadow-2xl border-t-4 border-red-500">
            <h3 class="text-2xl font-bold mb-4 text-red-400">DEPLOY NEW PROTOCOL</h3>
            <p id="challenge-error" class="text-red-400 text-sm mb-4"></p>
            
            <div class="mb-4">
                <label for="challenge-name" class="block text-sm font-medium text-gray-300 mb-1">Protocol Name</label>
                <!-- Updated input styles -->
                <input type="text" id="challenge-name" placeholder="Enter objective..." class="w-full p-3 bg-gray-700 border border-red-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500" maxlength="50">
            </div>

            <div class="mb-6">
                <label for="challenge-target-day" class="block text-sm font-medium text-gray-300 mb-1">Target Day (1 to 30)</label>
                <!-- Updated input styles -->
                <input type="number" id="challenge-target-day" min="1" max="30" value="15" class="w-full p-3 bg-gray-700 border border-red-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500">
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="window.closeModal('challenge-modal')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                    CANCEL
                </button>
                <!-- Kept red button for theme -->
                <button onclick="window.addCustomChallenge()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition-colors shadow-lg shadow-red-600/50">
                    SAVE & ACTIVATE
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Modal --><div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-gray-900 p-8 rounded-xl w-full max-w-lg shadow-2xl border-t-4 border-red-500">
            <h3 id="notification-title" class="text-3xl font-extrabold mb-4 text-red-400 neon-title">Status Update</h3>
            <p id="notification-content" class="text-lg text-gray-300 mb-6 leading-relaxed">
                <!-- Message content will be inserted here by JS --></p>
            
            <div class="flex justify-end">
                <!-- Changed button style to Red theme -->
                <button onclick="window.closeModal('notification-modal')" class="px-6 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition-colors shadow-lg shadow-red-600/50">
                    ACKNOWLEDGE
                </button>
            </div>
        </div>
    </div>

</body>
</html>
